
@{
    ViewBag.Title = "Clientes";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


<!-- Modal Agregar Cliente -->
<div class="modal" id="ModalAddCliente" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle"> <strong> Agregar Cliente </strong>  </h5>
                <button type="button" onclick="CerrarModal('ModalAddCliente')" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-sm-12 col-md-12">

                        <div class="form-group">
                            <label class="control-label"> Cédula: </label>
                            <input class="form-control" id="Cedula1" min="1"
                                   onkeypress="return event.charCode >= 48"
                                   oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);"
                                   type="number"
                                   maxlength="10" />
                           @* <input type="text" class="form-control" id="Cedula1" value="" />*@
                        </div>
                        <div class="form-group">
                            <label class="control-label"> Nombre y Apellido: </label>
                            <input type="text" class="form-control" id="Nombre1" maxlength="40" value="" />
                        </div>
                        <div class="form-group">
                            <label> Teléfono: </label>
                            @*<input type="text" class="form-control" id="Telefono1" value="" />*@

                            <input class="form-control" id="Telefono1" min="1"
                                   onkeypress="return event.charCode >= 48"
                                   oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);"
                                   type="number"
                                   maxlength="10" />
                        </div>
                        <div class="form-group">
                            <label> Dirección: </label>
                            <input type="text" class="form-control" maxlength="80" id="Direccion1" value="" />
                        </div>

                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="Agregar()" class="btn btn-success" data-dismiss="modal">Agregar Cliente</button>
            </div>
        </div>
    </div>
</div>
<!-- Modal Editar Cliente -->
<div class="modal" id="ModalEditarCliente" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle"> <strong> Agregar Cliente </strong>  </h5>
                <button type="button" onclick="CerrarModal('ModalEditarCliente')" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-sm-12 col-md-12">

                        <div class="form-group">
                            <label class="control-label"> Id: </label>

                            <input disabled type="text" class="form-control" id="Id2" value="" />
                        </div>



                        <div class="form-group">
                            <label class="control-label"> Cédula: </label>

                            <input class="form-control" id="Cedula2" min="1"
                                   onkeypress="return event.charCode >= 48"
                                   oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);"
                                   type="number"
                                   maxlength="10" />


                            @*<input type="text" class="form-control" id="Cedula2" value="" />*@
                        </div>

                        <div class="form-group">
                            <label class="control-label"> Nombre y Apellido: </label>
                            <input type="text" class="form-control" maxlength="40" id="Nombre2" value="" />
                        </div>
                        <div class="form-group">
                            <label> Teléfono: </label>

                            <input class="form-control" id="Telefono2" min="1"
                                   onkeypress="return event.charCode >= 48"
                                   oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);"
                                   type="number"
                                   maxlength="10" />

                            @*<input type="text" class="form-control" id="Telefono2" value="" />*@
                        </div>
                        <div class="form-group">
                            <label> Dirección: </label>
                            <input type="text" class="form-control" maxlength="80" id="Direccion2" value="" />
                        </div>
                        <div class="form-group">
                            <label> Estado: </label>
                            <input type="number" min="0" max="1" class="form-control" id="Estado" value="" />
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="Editar()" class="btn btn-success" data-dismiss="modal">Editar Cliente</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Eliminar Cliente -->
<div class="modal" id="ModalEliminarCliente" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle"> <strong> Eliminar Cliente </strong>  </h5>
                <button type="button" onclick="CerrarModal('ModalEliminarCliente')" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-sm-12 col-md-12">

                        <div class="form-group">
                            <label class="control-label"> Id: </label>
                            <input type="text" class="form-control" disabled id="Id3" value="" />
                        </div>

                        <div class="form-group">
                            <label class="control-label"> Cédula: </label>
                            <input type="text" class="form-control" disabled id="Cedula3" value="" />
                        </div>

                        <div class="form-group">
                            <label class="control-label"> Nombre: </label>
                            <input type="text" class="form-control" disabled id="Nombre3" value="" />
                        </div>
                        <div class="form-group">
                            <label> Teléfono: </label>
                            <input type="text" class="form-control" disabled id="Telefono3" value="" />
                        </div>
                        <div class="form-group">
                            <label> Dirección: </label>
                            <input type="text" class="form-control" disabled id="Direccion3" value="" />
                        </div>

                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="Eliminar()" class="btn btn-success" data-dismiss="modal">Eliminar Cliente</button>
            </div>
        </div>
    </div>
</div>

@if (ViewBag.UsuarioAdm == "0")
{
    <button class="btn btn-success" style="margin-top:20px" onclick="MostrarModalAgregar()">Agregar Cliente</button>
}

<div class="row">
    <div class="col-lg-12 col-md-12 col-sm-6">
        <div class="text-center">  <h2 style="color:black"> <strong> Cliente </strong> </h2>    </div>
        <div class="table-responsive">
            <table id="TableClientes" class="table table-striped" width="100%" style="background-color:darkgray">
                <thead style="background-color: #000000; color: white;">
                    <tr>
                        <th>#</th>
                        <th>ID</th>
                        <th>Cédula</th>
                        <th>Nombre</th>
                        <th>Teléfono</th>
                        <th>Dirección</th>
                        <th>Estado</th>
                        <th>Acciones</th>

                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

    </div>
</div>

<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs-3.3.7/dt-1.11.3/datatables.min.css" />
<script type="text/javascript" src="https://cdn.datatables.net/v/bs-3.3.7/dt-1.11.3/datatables.min.js"></script>
<script type="text/javascript">

    $.extend(true, $.fn.dataTable.defaults, {
        "language": {
            "decimal": ",",
            "thousands": ".",
            "info": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
            "infoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
            "infoPostFix": "",
            "infoFiltered": "(filtrado de un total de _MAX_ registros)",
            "loadingRecords": "Cargando...",
            "lengthMenu": "Mostrar _MENU_ registros",
            "paginate": {
                "first": "Primero",
                "last": "Último",
                "next": "Siguiente",
                "previous": "Anterior"
            },
            "processing": "Procesando...",
            "search": "Buscar:",
            "searchPlaceholder": "Término de búsqueda",
            "zeroRecords": "No se encontraron resultados",
            "emptyTable": "Ningún dato disponible en esta tabla",
            "aria": {
                "sortAscending": ": Activar para ordenar la columna de manera ascendente",
                "sortDescending": ": Activar para ordenar la columna de manera descendente"
            },
            //only works for built-in buttons, not for custom buttons
            "buttons": {
                "create": "Nuevo",
                "edit": "Cambiar",
                "remove": "Borrar",
                "copy": "Copiar",
                "csv": "fichero CSV",
                "excel": "tabla Excel",
                "pdf": "documento PDF",
                "print": "Imprimir",
                "colvis": "Visibilidad columnas",
                "collection": "Colección",
                "upload": "Seleccione fichero...."
            },
            "select": {
                "rows": {
                    _: '%d filas seleccionadas',
                    0: 'clic fila para seleccionar',
                    1: 'una fila seleccionada'
                }
            }
        }
    });

     var TableCliente;
    var Cliente = {};
    var ListaClientes = [];

    $(document).ready(function () {


        TableCliente = $('#TableClientes').DataTable({
            ordering: false,
            data: [],
            columns:
                [
                    { "data": "Num" },
                    { "data": "ClienteID", visible: false },
                    { "data": "Cedula" },
                    { "data": "NomCliente" },
                    { "data": "Telefono" },
                    { "data": "Direccion" },
                    {
                        "data": null, "visible": false,
                        "render": function (data, type, row) {
                            if (data.Estado == 1) {
                                return `<span class="badge bg-info">Activo</span>`;
                            }
                            return `<span class="badge bg-danger">Inactivo</span>`
                        }

                    },
                    {


                        "data": null,
                        "render": function (data) {

                            if ("@ViewBag.UsuarioAdm" == "0") {
                                if (data.Estado == 1) {
                                    return `<button id="editarCliente"  class="btn glyphicon glyphicon-pencil" style="color:#0b69ad"></button>` +
                                        `<button id="eliminarCliente" class="btn glyphicon glyphicon-trash" style="color:#0b69ad"></button>`
                                }
                                return `<button id="editarCliente"  class="btn glyphicon glyphicon-pencil" style="color:#0b69ad"></button>` +
                                    `<button id="eliminarCliente" disabled class="btn glyphicon glyphicon-trash" style="color:#0b69ad"></button>`
                            } else {
                                return `<button id="editarCliente" disabled  class="btn glyphicon glyphicon-pencil" style="color:#0b69ad"></button>` +
                                    `<button id="eliminarCliente" disabled class="btn glyphicon glyphicon-trash" style="color:#0b69ad"></button>`

                            }


                            
                        }
                    },
                ],
        });

        $("#TableClientes tbody").on("click", "#editarCliente", function () {
            var data = TableCliente.row($(this).parents('tr')).data();
            Cliente = data;
            console.log(data);

            $("#ModalEditarCliente").show();
            $("#Id2").val(data.ClienteID);
            $("#Cedula2").val(data.Cedula.trim());
            $("#Nombre2").val(data.NomCliente);
            $("#Direccion2").val(data.Direccion);
            $("#Telefono2").val(data.Telefono.trim());
            $("#Estado").val(data.Estado);

        });


        $("#TableClientes tbody").on("click", "#eliminarCliente", function () {
            var data = TableCliente.row($(this).parents('tr')).data();
            Cliente = data;

            console.log(Cliente);
            $("#ModalEliminarCliente").show();
            $("#Id3").val(data.ClienteID);
            $("#Cedula3").val(data.Cedula);
            $("#Nombre3").val(data.NomCliente);
            $("#Direccion3").val(data.Direccion);
            $("#Telefono3").val(data.Telefono);

        });

                CargarClientes();

    });

    function SweetAlertMensaje(Titulo, Texto, Icono) {
        swal({
            title: Titulo,
            text: Texto,
            icon: Icono,
            dangerMode: true,
        });

    }

    function validarCed(ced) {
        const cedula = ced;
        if (cedula.length == 10) {

            //Obtenemos el digito de la region que sonlos dos primeros digitos
            var digito_region = cedula.substring(0, 2);

            //Pregunto si la region existe ecuador se divide en 24 regiones
            if (digito_region >= 1 && digito_region <= 24) {

                // Extraigo el ultimo digito
                var ultimo_digito = cedula.substring(9, 10);

                //Agrupo todos los pares y los sumo
                var pares = parseInt(cedula.substring(1, 2)) + parseInt(cedula.substring(3, 4)) + parseInt(cedula.substring(5, 6)) + parseInt(cedula.substring(7, 8));

                //Agrupo los impares, los multiplico por un factor de 2, si la resultante es > que 9 le restamos el 9 a la resultante
                var numero1 = cedula.substring(0, 1);
                var numero1 = (numero1 * 2);
                if (numero1 > 9) { var numero1 = (numero1 - 9); }

                var numero3 = cedula.substring(2, 3);
                var numero3 = (numero3 * 2);
                if (numero3 > 9) { var numero3 = (numero3 - 9); }

                var numero5 = cedula.substring(4, 5);
                var numero5 = (numero5 * 2);
                if (numero5 > 9) { var numero5 = (numero5 - 9); }

                var numero7 = cedula.substring(6, 7);
                var numero7 = (numero7 * 2);
                if (numero7 > 9) { var numero7 = (numero7 - 9); }

                var numero9 = cedula.substring(8, 9);
                var numero9 = (numero9 * 2);
                if (numero9 > 9) { var numero9 = (numero9 - 9); }

                var impares = numero1 + numero3 + numero5 + numero7 + numero9;

                //Suma total
                var suma_total = (pares + impares);

                //extraemos el primero digito
                var primer_digito_suma = String(suma_total).substring(0, 1);

                //Obtenemos la decena inmediata
                var decena = (parseInt(primer_digito_suma) + 1) * 10;

                //Obtenemos la resta de la decena inmediata - la suma_total esto nos da el digito validador
                var digito_validador = decena - suma_total;

                //Si el digito validador es = a 10 toma el valor de 0
                if (digito_validador == 10)
                    var digito_validador = 0;

                //Validamos que el digito validador sea igual al de la cedula
                if (digito_validador == ultimo_digito) {
                    return true;
                } else {
                    return false;
                }

            } else {
                // imprimimos en consola si la region no pertenece
                return false;
            }
        } else {
            //imprimimos en consola si la cedula tiene mas o menos de 10 digitos
            return false;
        }    
    }

    function Agregar() {
        Cliente = {};

        var cedula = $("#Cedula1").val();
        if (cedula.length != 10) {
            SweetAlertMensaje("Cédula", "Debe 10 dígitos", 'warning');
            return;
        }

        if (!validarCed(cedula)) {
            SweetAlertMensaje("Cédula", "No válida", 'warning');
            return;
        }

        var nombre = $("#Nombre1").val();

        var name = nombre.split(' ').length;
        if (name < 2 || name > 2) {
            SweetAlertMensaje("Nombre y Apellido", "Debe ingresar un nombre y un apellido", 'warning');
            return;
        }

        var telefono = $("#Telefono1").val();
        if (telefono.length != 10) {
            SweetAlertMensaje("Teléfono", "Debe 10 dígitos", 'warning');
            return;
        }
        var direccion = $("#Direccion1").val();

        if (cedula == "" || nombre== "" || telefono== "" || direccion == "" ) {
           SweetAlertMensaje("Precio", "Uno o mas campos vacíos", 'warning');
           return;
       }
        Cliente.Cedula         =  cedula;
        Cliente.NomCliente     =  nombre;
        Cliente.Telefono = telefono;
        Cliente.Direccion = direccion;



        $.ajax({
            url: "@Url.Content("~/Cliente/AgregarCliente")",
            dataType: 'json',
             type: 'POST',
             data: Cliente ,
            success: function (data) {
                console.log(data)
                 if (!data.Datos) {
                    return SweetAlertMensaje("Error", data.Error, "error");
                 }
                 SweetAlertMensaje("Cliente", "Cliente Agregado", 'success');
                 CerrarModal("ModalAddCliente");
                 CargarClientes();
            },
             error: function (err) {
                console.log('err', err)
                SweetAlertMensaje("Error","Error al Agregar Cliente","error");
            }
        });
    }

    function Eliminar(){

        console.log(Cliente);
         $.ajax({
            url: "@Url.Content("~/Cliente/EliminarCliente")",
            dataType: 'json',
             type: 'POST',
             data: Cliente ,
             success: function (data) {

                 if (!data.Datos) {
                 return   SweetAlertMensaje("Error", data.Error, "error");
                 }
                 SweetAlertMensaje("Cliente", 'Se Elimino el Cliente', "success");

                 CerrarModal("ModalEliminarCliente");
                 CargarClientes();

            },
             error: function (err) {
                console.log('err', err)
                SweetAlertMensaje("Error","Error al Eliminar Cliente","error");
            }
        });


    }

    function MostrarModalAgregar() {
        $('#ModalAddCliente').show();
    }

    function Editar() {


        var cedula = $("#Cedula2").val();
        if (cedula.length != 10) {
            SweetAlertMensaje("Cédula", "Debe 10 dígitos", 'warning');
            return;
        }
        if (!validarCed(cedula)) {
            SweetAlertMensaje("Cédula", "No válida", 'warning');
            return;
        }
        var nombre = $("#Nombre2").val();
        var telefono = $("#Telefono2").val();
        var direccion = $("#Direccion2").val();
        var estado = $("#Estado").val();

        if (cedula == "" || nombre == "" || telefono == "" || direccion == "") {
            SweetAlertMensaje("Precio", "Uno o mas campos vacíos", 'warning');
            return;
        }
        Cliente.Cedula = cedula;
        Cliente.NomCliente = nombre;
        Cliente.Telefono = telefono;
        Cliente.Direccion = direccion;
        Cliente.Estado = estado;
        

        console.log(Cliente);
         $.ajax({
            url: "@Url.Content("~/Cliente/EditarCliente")",
            dataType: 'json',
             type: 'POST',
             data: Cliente ,
             success: function (data) {
                 console.log('succ', data)

                if (data.Datos == false) {
                    return SweetAlertMensaje("Error", data.Error, "error");
                 }

                 SweetAlertMensaje("Cliente", "Se edito el Cliente", "success");
                 CerrarModal("ModalEditarCliente");
                 CargarClientes();
            },
             error: function (err) {
                console.log('err', err)
                SweetAlertMensaje("Error","Error al Editar Cliente","error");
            }
        });





    }


    function CerrarModal(NombreModal) {

        $("#" + NombreModal).hide();
    }

        function CargarClientes() {
        $.ajax({
            url: "@Url.Content("~/Factura/ObtenerClientes")",
            dataType: 'json',
            type: 'POST',
            success: function (data) {
                if (data.Error != null ) {
                    SweetAlertMensaje("Error", data.Error, "error");
                } else {
                    TableCliente.clear().draw();
                    TableCliente.rows.add(data.Datos).draw();
                }
            },
            error: function (err) {
                SweetAlertMensaje("Error","Error al Cargar Productos","error");
            }
        });
    }

</script>
